<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Neo Chess Board - Chess.js Integration Demo</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      .board-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        flex: 1;
        min-width: 480px;
      }
      .controls {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        width: 350px;
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 10px;
      }
      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
      }
      .feature-box {
        background: #e7f3ff;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
      }
      .feature-box h3 {
        margin-top: 0;
        color: #1976d2;
      }
      .status-box {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
      }
      .status-box h3 {
        margin-top: 0;
        color: #333;
      }
      .status-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .status-value {
        font-weight: bold;
      }
      .check {
        color: #dc3545;
      }
      .checkmate {
        color: #dc3545;
        font-weight: bold;
      }
      .stalemate {
        color: #ffc107;
        font-weight: bold;
      }
      .normal {
        color: #28a745;
      }
      .fifty-warning {
        color: #ff9800;
        font-weight: 600;
      }
      .fifty-limit {
        color: #dc3545;
        font-weight: bold;
      }

      button {
        background: #2196f3;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
        width: calc(50% - 10px);
      }
      button:hover {
        background: #1976d2;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .moves-list {
        max-height: 150px;
        overflow-y: auto;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        font-family: monospace;
        font-size: 12px;
      }

      .move-counter {
        text-align: center;
        padding: 10px;
        background: #007bff;
        color: white;
        border-radius: 4px;
        margin-bottom: 15px;
      }

      .comparison {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
      }
      .comparison h3 {
        margin-top: 0;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="board-container">
        <h1>Chess.js Integration Demo</h1>
        <p class="subtitle">Validation robuste des coups avec chess.js</p>

        <!-- Le board sera inject√© ici -->
        <div id="board"></div>
      </div>

      <div class="controls">
        <div class="comparison">
          <h3>üÜö Comparaison des moteurs</h3>
          <p><strong>Avant:</strong> LightRules (validation basique)</p>
          <p><strong>Maintenant:</strong> Chess.js (validation compl√®te)</p>
          <p>‚úÖ √âchec et mat d√©tect√©</p>
          <p>‚úÖ Pat d√©tect√©</p>
          <p>‚úÖ R√®gles sp√©ciales (roque, en passant)</p>
          <p>‚úÖ Historique des coups</p>
          <p>‚úÖ Export/Import PGN complet</p>
        </div>

        <div class="move-counter">
          <div><strong>Coup n¬∞</strong> <span id="move-number">1</span></div>
          <div>Au trait: <span id="current-turn">Blancs</span></div>
        </div>

        <div class="status-box">
          <h3>√âtat de la partie:</h3>
          <div class="status-item">
            <span>Statut:</span>
            <span id="game-status" class="status-value normal">En cours</span>
          </div>
          <div class="status-item">
            <span>√âchec:</span>
            <span id="check-status" class="status-value">Non</span>
          </div>
          <div class="status-item">
            <span>Coups possibles:</span>
            <span id="moves-count" class="status-value">20</span>
          </div>
          <div class="status-item">
            <span>Demi-coups:</span>
            <span id="half-moves" class="status-value">0</span>
          </div>
          <div class="status-item">
            <span>R√®gle des 50 coups:</span>
            <span id="fifty-move-status" class="status-value">100 demi-coups restants</span>
          </div>
        </div>

        <div class="feature-box">
          <h3>üéØ Fonctionnalit√©s Chess.js</h3>
          <ul>
            <li><strong>Validation compl√®te</strong> des coups</li>
            <li><strong>D√©tection automatique</strong> √©chec/mat/pat</li>
            <li><strong>Gestion des r√®gles</strong> sp√©ciales</li>
            <li><strong>Historique</strong> des coups</li>
            <li><strong>Positions FEN</strong> valid√©es</li>
            <li><strong>Suivi de l'horloge 50 coups</strong> en direct</li>
          </ul>
        </div>

        <h3>Actions rapides:</h3>
        <button onclick="resetGame()">üîÑ Nouvelle partie</button>
        <button onclick="undoMove()" id="undo-btn">‚Ü∂ Annuler</button>
        <button onclick="loadPosition('scholar')">üéì Mat du berger</button>
        <button onclick="loadPosition('stalemate')">‚öñÔ∏è Position de pat</button>
        <button onclick="loadPosition('endgame')">‚ôî Fin de partie</button>
        <button onclick="loadPosition('castling')">üè∞ Test roque</button>
        <button onclick="loadFamousGame()">üåü Partie Immortelle</button>

        <h3>Export PGN:</h3>
        <button onclick="exportPgn()">üìÑ Voir PGN</button>
        <button onclick="downloadPgn()">üíæ T√©l√©charger PGN</button>
        <button onclick="showLoadPgnDialog()">üìÇ Charger PGN</button>
        <button onclick="copyPgnToClipboard()">üìã Copier PGN</button>

        <h3>Historique des coups:</h3>
        <div class="moves-list" id="moves-history">Position initiale</div>

        <!-- Modal pour afficher/charger PGN -->
        <div
          id="pgn-modal"
          style="
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
          "
        >
          <div
            style="
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: white;
              padding: 20px;
              border-radius: 8px;
              max-width: 600px;
              width: 90%;
            "
          >
            <h3 id="modal-title">Export PGN</h3>
            <textarea
              id="pgn-content"
              style="
                width: 100%;
                height: 200px;
                font-family: monospace;
                font-size: 12px;
                border: 1px solid #ccc;
                border-radius: 4px;
                padding: 10px;
                resize: vertical;
              "
            ></textarea>
            <div style="margin-top: 15px; text-align: right">
              <button onclick="closePgnModal()" style="background: #6c757d; margin-right: 10px">
                Fermer
              </button>
              <button
                id="load-pgn-btn"
                onclick="loadFromPgn()"
                style="display: none; background: #28a745"
              >
                Charger
              </button>
              <button onclick="copyPgnToClipboard()" style="background: #007bff">Copier</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { NeoChessBoard, ChessJsRules } from '../dist/index.js';

      // Cr√©er le board avec ChessJsRules
      const board = new NeoChessBoard('#board', {
        position: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
        rulesAdapter: new ChessJsRules(), // Utiliser explicitement ChessJsRules
        showArrows: true,
        showHighlights: true,
        rightClickHighlights: true,
        interactive: true,
        showCoordinates: true,
      });

      // Variables globales - Cr√©er une instance s√©par√©e pour les fonctions avanc√©es
      let chessRules = new ChessJsRules();
      chessRules.setFEN('rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1');

      // Configurer les m√©tadonn√©es PGN par d√©faut conformes aux standards
      chessRules.setPgnMetadata({
        Event: 'Neo Chess Board Demo',
        Site: 'Local Demo',
        White: 'Player White',
        Black: 'Player Black',
        Date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
        WhiteElo: '1500',
        BlackElo: '1500',
        TimeControl: '300+3',
        ECO: '?',
        Opening: '?',
      });

      // Fonction pour mettre √† jour le statut
      function updateStatus() {
        const moveNumber = chessRules.moveNumber();
        const turn = chessRules.turn();
        const inCheck = chessRules.inCheck();
        const isCheckmate = chessRules.isCheckmate();
        const isStalemate = chessRules.isStalemate();
        const isGameOver = chessRules.isGameOver();
        const moves = chessRules.getAllMoves();
        const halfMoves = chessRules.halfMoves();
        const halfMovesRemaining = Math.max(0, 100 - halfMoves);
        const history = chessRules.history();

        // Mettre √† jour l'affichage
        document.getElementById('move-number').textContent = moveNumber;
        document.getElementById('current-turn').textContent = turn === 'w' ? 'Blancs' : 'Noirs';
        document.getElementById('moves-count').textContent = moves.length;
        document.getElementById('half-moves').textContent = halfMoves;
        const fiftyMoveEl = document.getElementById('fifty-move-status');
        if (fiftyMoveEl) {
          if (halfMoves >= 100) {
            fiftyMoveEl.textContent = 'Limite des 50 coups atteinte';
            fiftyMoveEl.className = 'status-value fifty-limit';
          } else {
            fiftyMoveEl.textContent = `${halfMovesRemaining} demi-coups restants`;
            fiftyMoveEl.className = halfMoves >= 80 ? 'status-value fifty-warning' : 'status-value';
          }
        }

        // Statut d'√©chec
        const checkEl = document.getElementById('check-status');
        if (inCheck) {
          checkEl.textContent = 'Oui';
          checkEl.className = 'status-value check';
        } else {
          checkEl.textContent = 'Non';
          checkEl.className = 'status-value';
        }

        // Statut de la partie
        const statusEl = document.getElementById('game-status');
        if (isCheckmate) {
          statusEl.textContent = 'üèÜ √âchec et mat';
          statusEl.className = 'status-value checkmate';
        } else if (isStalemate) {
          statusEl.textContent = '‚öñÔ∏è Pat';
          statusEl.className = 'status-value stalemate';
        } else if (isGameOver) {
          statusEl.textContent = 'üèÅ Partie termin√©e';
          statusEl.className = 'status-value';
        } else {
          statusEl.textContent = '‚ö° En cours';
          statusEl.className = 'status-value normal';
        }

        // Historique des coups
        const historyEl = document.getElementById('moves-history');
        if (history.length === 0) {
          historyEl.textContent = 'Position initiale';
        } else {
          historyEl.innerHTML = history
            .map((move, i) => {
              const moveNum = Math.floor(i / 2) + 1;
              const isWhite = i % 2 === 0;
              return isWhite ? `${moveNum}. ${move}` : `${move}`;
            })
            .join(' ');
        }

        // Bouton Annuler
        const undoBtn = document.getElementById('undo-btn');
        undoBtn.disabled = history.length === 0;
      }

      // Actions globales
      window.resetGame = function () {
        chessRules.reset();
        board.setPosition(chessRules.getFEN(), true);
        updateStatus();
      };

      window.undoMove = function () {
        if (chessRules.undo()) {
          board.setPosition(chessRules.getFEN(), true);
          updateStatus();
        }
      };

      window.loadPosition = function (positionType) {
        let fen;

        switch (positionType) {
          case 'scholar':
            // Mat du berger
            fen = 'rnbqkb1r/pppp1ppp/5n2/4p3/2B1P3/3P1Q2/PPP2PPP/RNB1K1NR b KQkq - 0 4';
            break;
          case 'stalemate':
            // Position de pat
            fen = 'k7/8/1K6/8/8/8/8/1Q6 b - - 0 1';
            break;
          case 'endgame':
            // Fin de partie roi + dame vs roi
            fen = '8/8/8/8/8/3k4/8/K2Q4 w - - 0 1';
            break;
          case 'castling':
            // Position pour tester les roques
            fen = 'r3k2r/pppppppp/8/8/8/8/PPPPPPPP/R3K2R w KQkq - 0 1';
            break;
          default:
            fen = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
        }

        chessRules.setFEN(fen);
        board.setPosition(fen, true);
        updateStatus();
      };

      // √âcouter les √©v√©nements du board
      board.on('move', (data) => {
        console.log('Coup jou√©:', data);
        // Synchroniser l'instance de suivi avec le board
        chessRules.setFEN(data.fen);
        updateStatus();

        // V√©rifier la fin de partie
        if (chessRules.isGameOver()) {
          setTimeout(() => {
            let message;
            if (chessRules.isCheckmate()) {
              const winner = chessRules.turn() === 'w' ? 'Noirs' : 'Blancs';
              message = `üéâ √âchec et mat ! Les ${winner} ont gagn√© !`;
            } else if (chessRules.isStalemate()) {
              message = '‚öñÔ∏è Pat ! Match nul.';
            } else {
              message = 'üèÅ Partie termin√©e. Match nul.';
            }
            alert(message);
          }, 100);
        }
      });

      board.on('illegal', (data) => {
        console.log('Coup ill√©gal tent√©:', data);
        alert(`Coup ill√©gal: ${data.from}-${data.to}\nRaison: ${data.reason}`);
      });

      // Mise √† jour initiale
      updateStatus();

      // D√©mo automatique (optionnel)
      let demoMoves = ['e2', 'e4', 'e7', 'e5', 'f1', 'c4', 'b8', 'c6', 'd1', 'h5'];
      let demoIndex = 0;
      let demoMode = false;

      window.startDemo = function () {
        if (demoMode) return;
        demoMode = true;

        const playNextMove = () => {
          if (demoIndex >= demoMoves.length - 1 || chessRules.isGameOver()) {
            demoMode = false;
            return;
          }

          const from = demoMoves[demoIndex];
          const to = demoMoves[demoIndex + 1];

          // Simuler un coup
          const moveResult = chessRules.move({ from, to });
          if (moveResult.ok) {
            board.setPosition(chessRules.getFEN());
            updateStatus();
          }

          demoIndex += 2;
          setTimeout(playNextMove, 1500);
        };

        resetGame();
        setTimeout(playNextMove, 1000);
      };

      // Fonctions PGN
      window.exportPgn = function () {
        const pgn = chessRules.toPgn();
        document.getElementById('pgn-content').value = pgn;
        document.getElementById('modal-title').textContent = 'Export PGN - Partie Actuelle';
        document.getElementById('load-pgn-btn').style.display = 'none';
        document.getElementById('pgn-modal').style.display = 'block';
      };

      window.downloadPgn = function () {
        const filename = `chess-game-${new Date().toISOString().split('T')[0]}.pgn`;
        chessRules.downloadPgn(filename);
      };

      window.showLoadPgnDialog = function () {
        document.getElementById('pgn-content').value = '';
        document.getElementById('modal-title').textContent = 'Charger PGN - Coller votre PGN ici';
        document.getElementById('load-pgn-btn').style.display = 'inline-block';
        document.getElementById('pgn-modal').style.display = 'block';
      };

      window.loadFromPgn = function () {
        const pgn = document.getElementById('pgn-content').value.trim();
        if (!pgn) {
          alert('Veuillez saisir un PGN valide.');
          return;
        }

        const success = chessRules.loadPgn(pgn);
        if (success) {
          board.setPosition(chessRules.getFEN(), true);
          updateStatus();
          closePgnModal();
          alert('PGN charg√© avec succ√®s !');
        } else {
          alert('Erreur: PGN invalide. V√©rifiez le format.');
        }
      };

      window.closePgnModal = function () {
        document.getElementById('pgn-modal').style.display = 'none';
      };

      window.copyPgnToClipboard = function () {
        const pgnContent = document.getElementById('pgn-content');
        pgnContent.select();
        pgnContent.setSelectionRange(0, 99999); // Pour mobile

        try {
          document.execCommand('copy');
          alert('PGN copi√© dans le presse-papiers !');
        } catch (err) {
          console.error('Erreur lors de la copie:', err);
          alert('Erreur lors de la copie. S√©lectionnez et copiez manuellement.');
        }
      };

      // Exemple de PGN c√©l√®bre pour les tests
      window.loadFamousGame = function () {
        const immortalGame = `[Event "Immortal Game"]
[Site "London"]
[Date "1851.06.21"]
[Round "?"]
[White "Anderssen, Adolf"]
[Black "Kieseritzky, Lionel"]
[Result "1-0"]

1. e4 e5 2. f4 exf4 3. Bc4 Qh4+ 4. Kf1 b5 5. Bxb5 Nf6 6. Nf3 Qh6 7. d3 Nh5 8. Nh4 Qg5 9. Nf5 c6 10. g4 Nf6 11. Rg1 cxb5 12. h4 Qg6 13. h5 Qg5 14. Qf3 Ng8 15. Bxf4 Qf6 16. Nc3 Bc5 17. Nd5 Qxb2 18. Bd6 Bxg1 19. e5 Qxa1+ 20. Ke2 Na6 21. Nxg7+ Kd8 22. Qf6+ Nxf6 23. Be7# 1-0`;

        document.getElementById('pgn-content').value = immortalGame;
        document.getElementById('modal-title').textContent =
          'PGN - Partie Immortelle (Anderssen vs Kieseritzky, 1851)';
        document.getElementById('load-pgn-btn').style.display = 'inline-block';
        document.getElementById('pgn-modal').style.display = 'block';
      };

      // Fermer le modal en cliquant √† l'ext√©rieur
      document.getElementById('pgn-modal').addEventListener('click', function (e) {
        if (e.target === this) {
          closePgnModal();
        }
      });
    </script>
  </body>
</html>
