<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Live Chess.js integration demo showcasing Neo Chess Board with advanced validation, status tracking, and PGN tools."
    />
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "chess.js": "https://esm.sh/chess.js@1.0.0-beta.8"
        }
      }
    </script>
                <title>Neo Chess Board - Chess.js Integration Demo</title>
    <link rel="stylesheet" href="./chess-ui-framework.css" />
    <style>
      body {
        margin: 0;
        padding: var(--sp-xl) var(--sp-lg);
        background:
          radial-gradient(circle at top left, hsl(var(--h-accent) 83% 66% / 0.16), transparent 55%),
          radial-gradient(circle at bottom right, hsl(var(--h-info) 92% 60% / 0.12), transparent 55%),
          var(--bg-0);
        color: var(--text-0);
        min-block-size: 100vh;
      }

      .container {
        max-inline-size: 1280px;
        margin-inline: auto;
        display: flex;
        flex-wrap: wrap;
        gap: var(--sp-lg);
      }

      .language-row {
        flex-basis: 100%;
        display: flex;
        justify-content: flex-end;
      }

      .language-toggle {
        background: var(--bg-input);
        color: var(--text-0);
        border: 1px solid var(--bd-accent);
        border-radius: var(--r-full);
        padding: var(--sp-xs) var(--sp-md);
        font-size: var(--fs-400);
        font-weight: 600;
        cursor: pointer;
        transition: transform var(--t-base), box-shadow var(--t-base), background var(--t-base);
        box-shadow: var(--shadow-sm);
      }

      .language-toggle:hover {
        transform: translateY(-1px);
        background: var(--bg-hover);
        box-shadow: var(--shadow-md);
      }

      .language-toggle:active {
        transform: translateY(0);
      }

      .board-container,
      .controls {
        background: var(--bg-card);
        border-radius: var(--r-xl);
        padding: var(--sp-lg);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--bd-0);
      }

      .board-container {
        flex: 1 1 540px;
        min-inline-size: min(100%, 360px);
      }

      .controls {
        flex: 0 0 360px;
        display: flex;
        flex-direction: column;
        gap: var(--sp-md);
      }

      h1 {
        text-align: center;
        margin-block-end: var(--sp-xs);
      }

      .subtitle {
        text-align: center;
        color: var(--text-1);
        margin-block-end: var(--sp-lg);
      }

      .demo-board {
        inline-size: min(100%, 520px);
        margin-inline: auto;
        margin-block-end: var(--sp-lg);
        border-radius: var(--r-lg);
        overflow: hidden;
        box-shadow: var(--shadow-lg);
      }

      .feature-box {
        background: hsl(var(--h-info) 92% 60% / 0.14);
        border-inline-start: 4px solid var(--accent-info);
        border-radius: var(--r-lg);
        padding: var(--sp-md);
      }

      .feature-box h3 {
        margin-block-start: 0;
        color: var(--accent-info);
      }

      .status-box {
        background: var(--bg-1);
        border: 1px solid var(--bd-1);
        border-radius: var(--r-lg);
        padding: var(--sp-md);
        margin-block-end: var(--sp-md);
      }

      .status-box h3 {
        margin-block-start: 0;
        margin-block-end: var(--sp-sm);
      }

      .move-counter {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: var(--sp-sm);
        background: hsl(var(--h-accent) 83% 66% / 0.18);
        border-radius: var(--r-lg);
        padding: var(--sp-sm) var(--sp-md);
        margin-block-end: var(--sp-md);
        border: 1px solid var(--bd-accent);
      }

      .move-counter strong {
        display: block;
        font-size: var(--fs-400);
        color: var(--text-1);
      }

      .move-counter span:last-child {
        font-size: var(--fs-600);
        font-weight: 700;
        color: var(--text-0);
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--sp-sm);
        margin-block-end: var(--sp-xs);
      }

      .status-value {
        font-weight: 600;
        color: var(--text-0);
      }

      textarea,
      input,
      select {
        border: 1px solid var(--bd-0);
        border-radius: var(--r-md);
        padding: var(--sp-sm);
        font-size: var(--fs-400);
        background: var(--bg-input);
        color: var(--text-0);
        transition: border-color var(--t-base), box-shadow var(--t-base), background var(--t-base);
      }

      textarea:focus,
      input:focus,
      select:focus {
        outline: none;
        border-color: var(--accent-0);
        box-shadow: 0 0 0 3px hsl(var(--h-accent) 83% 66% / 0.2);
        background: var(--bg-hover);
      }

      textarea {
        min-block-size: 120px;
        resize: vertical;
        font-family: var(--font-mono);
      }

      .game-info {
        background: var(--bg-input);
        padding: var(--sp-md);
        border-radius: var(--r-lg);
        border: 1px solid var(--bd-1);
        margin-block-start: var(--sp-md);
      }

      .status {
        font-weight: 600;
        padding: var(--sp-xs) var(--sp-sm);
        border-radius: var(--r-full);
        margin-inline-start: var(--sp-xs);
        display: inline-flex;
        align-items: center;
        gap: var(--sp-xs);
      }

      .status.playing {
        background: hsl(var(--h-success) 65% 47% / 0.18);
        color: var(--accent-success);
      }
      .status.check {
        background: hsl(var(--h-warning) 95% 52% / 0.18);
        color: var(--accent-warning);
      }
      .status.checkmate {
        background: hsl(var(--h-error) 86% 58% / 0.18);
        color: var(--accent-error);
      }

      .moves-list {
        max-block-size: 180px;
        overflow-y: auto;
        background: var(--bg-input);
        border: 1px solid var(--bd-1);
        border-radius: var(--r-lg);
        padding: var(--sp-sm);
        margin-block-start: var(--sp-sm);
      }

      .controls h3 {
        margin: 0;
      }

      .comparison {
        background: hsl(var(--h-warning) 95% 52% / 0.18);
        border: 1px solid hsl(var(--h-warning) 95% 52% / 0.35);
        border-radius: var(--r-lg);
        padding: var(--sp-md);
        margin-block-end: var(--sp-md);
      }

      .comparison h3 {
        margin: 0 0 var(--sp-xs) 0;
        color: var(--accent-warning);
      }

      .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: hsl(233 40% 8% / 0.65);
        backdrop-filter: blur(4px);
        z-index: var(--z-3);
      }

      .modal-dialog {
        position: absolute;
        inset-block-start: 50%;
        inset-inline-start: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-card);
        border-radius: var(--r-xl);
        border: 1px solid var(--bd-0);
        padding: var(--sp-lg);
        inline-size: min(90vw, 600px);
        box-shadow: var(--shadow-xl);
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--sp-sm);
        margin-block-start: var(--sp-md);
      }

      .modal-footer button {
        inline-size: auto;
      }

      @media (max-width: 1024px) {
        .container {
          flex-direction: column;
        }

        .controls {
          flex: 1 1 auto;
        }
      }

      @media (max-width: 640px) {
        body {
          padding: var(--sp-lg) var(--sp-md);
        }

        .board-container,
        .controls {
          padding: var(--sp-md);
        }

        .modal-dialog {
          inline-size: min(92vw, 520px);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="language-row">
        <button id="language-toggle" class="language-toggle" data-i18n="language.toggle.fr"></button>
      </div>
      <div class="board-container">
        <h1 data-i18n="heading.title">♞ Chess.js Integration Demo</h1>
        <p class="subtitle" data-i18n="heading.subtitle">Robust move validation with chess.js.</p>

        <div id="board" class="demo-board"></div>

        <div class="comparison">
          <h3 data-i18n="comparison.title">🆚 Engine comparison</h3>
          <div data-i18n-html="comparison.content">
            <p><strong>Before:</strong> LightRules (basic validation)</p>
            <p><strong>Now:</strong> Chess.js (complete validation)</p>
            <p>✅ Checkmate detection</p>
            <p>✅ Stalemate detection</p>
            <p>✅ Special rules (castling, en passant)</p>
            <p>✅ Move history tracking</p>
            <p>✅ Full PGN import/export</p>
          </div>
        </div>

        <div class="move-counter">
          <div>
            <strong data-i18n="status.moveNumberLabel">Move #</strong>
            <span id="move-number">1</span>
          </div>
          <div>
            <span data-i18n="status.turnPrefix">Side to move:</span>
            <span id="current-turn" data-i18n="status.turn.white">White</span>
          </div>
        </div>

        <div class="status-box">
          <h3 data-i18n="status.panelHeading">Game status:</h3>
          <div class="status-item">
            <span data-i18n="status.label">Status:</span>
            <span id="game-status" class="status-value normal" data-i18n="status.state.inProgress">⚡ In progress</span>
          </div>
          <div class="status-item">
            <span data-i18n="status.checkLabel">Check:</span>
            <span id="check-status" class="status-value" data-i18n="status.check.no">No</span>
          </div>
          <div class="status-item">
            <span data-i18n="status.movesLabel">Legal moves:</span>
            <span id="moves-count" class="status-value">20</span>
          </div>
          <div class="status-item">
            <span data-i18n="status.halfMovesLabel">Half-moves:</span>
            <span id="half-moves" class="status-value">0</span>
          </div>
          <div class="status-item">
            <span data-i18n="status.fiftyLabel">50-move rule:</span>
            <span id="fifty-move-status" class="status-value" data-i18n="status.fifty.remaining">100 half-moves remaining</span>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="feature-box">
          <h3 data-i18n="features.title">🎯 Chess.js capabilities</h3>
          <ul data-i18n-html="features.list">
            <li><strong>Full validation</strong> for legal moves</li>
            <li><strong>Automatic detection</strong> for check, checkmate, and stalemate</li>
            <li><strong>Advanced rule</strong> support for castling and en passant</li>
            <li><strong>Move history</strong> kept in sync</li>
            <li><strong>FEN positions</strong> verified on load</li>
            <li><strong>50-move counter</strong> updated live</li>
          </ul>
        </div>

        <h3 data-i18n="actions.heading">Quick actions:</h3>
        <button class="chess-btn chess-btn--primary" onclick="resetGame()" data-i18n="actions.reset">🔄 New game</button>
        <button class="chess-btn chess-btn--secondary" onclick="undoMove()" id="undo-btn" data-i18n="actions.undo">↶ Undo</button>
        <button class="chess-btn chess-btn--secondary" onclick="loadPosition('scholar')" data-i18n="actions.scholar">🎓 Scholar's mate</button>
        <button class="chess-btn chess-btn--secondary" onclick="loadPosition('stalemate')" data-i18n="actions.stalemate">⚖️ Stalemate scenario</button>
        <button class="chess-btn chess-btn--secondary" onclick="loadPosition('endgame')" data-i18n="actions.endgame">♔ Endgame practice</button>
        <button class="chess-btn chess-btn--secondary" onclick="loadPosition('castling')" data-i18n="actions.castling">🏰 Castle test</button>
        <button class="chess-btn chess-btn--secondary" onclick="loadFamousGame()" data-i18n="actions.famous">🌟 Immortal Game</button>

        <h3 data-i18n="export.heading">PGN export:</h3>
        <button class="chess-btn chess-btn--secondary" onclick="exportPgn()" data-i18n="export.view">📄 View PGN</button>
        <button class="chess-btn chess-btn--secondary" onclick="downloadPgn()" data-i18n="export.download">💾 Download PGN</button>
        <button class="chess-btn chess-btn--secondary" onclick="showLoadPgnDialog()" data-i18n="export.load">📂 Load PGN</button>
        <button class="chess-btn chess-btn--secondary" onclick="copyPgnToClipboard()" data-i18n="export.copy">📋 Copy PGN</button>

        <h3 data-i18n="history.heading">Move history:</h3>
        <div class="moves-list" id="moves-history" data-i18n="history.initial">Initial position</div>

        <div id="pgn-modal" class="modal-overlay">
          <div class="modal-dialog">
            <h3 id="modal-title" data-i18n="modal.title.default">PGN viewer</h3>
            <textarea id="pgn-content" class="chess-input chess-textarea"></textarea>
            <div class="modal-footer">
              <button class="chess-btn chess-btn--secondary" onclick="closePgnModal()" data-i18n="modal.button.close">
                Close
              </button>
              <button
                id="load-pgn-btn"
                class="chess-btn chess-btn--success"
                onclick="loadFromPgn()"
                hidden
                data-i18n="modal.button.load"
              >
                Load
              </button>
              <button class="chess-btn chess-btn--primary" onclick="copyPgnToClipboard()" data-i18n="modal.button.copy">
                Copy
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { setupI18n } from './i18n.js';

      document.addEventListener('DOMContentLoaded', async () => {
        const i18n = setupI18n('chessJs');
        const { translate } = i18n;

        const languageToggle = document.getElementById('language-toggle');
        const updateLanguageToggle = () => {
          const key = i18n.getLanguage() === 'en' ? 'language.toggle.fr' : 'language.toggle.en';
          languageToggle.textContent = translate(key);
        };
        updateLanguageToggle();
        languageToggle.addEventListener('click', () => {
          const nextLanguage = i18n.getLanguage() === 'en' ? 'fr' : 'en';
          i18n.setLanguage(nextLanguage);
          updateLanguageToggle();
          updateStatus();
        });

        async function loadNeoChessModule() {
          return await import('../index.js');
        }

        let NeoChessBoard;
        let ChessJsRules;
        try {
          const neoChessModule = await loadNeoChessModule();
          NeoChessBoard = neoChessModule.NeoChessBoard;
          ChessJsRules = neoChessModule.ChessJsRules;
        } catch (error) {
          console.error('Unable to load Neo Chess Board', error);
          alert(translate('alerts.loadingError'));
          throw error;
        }

        const boardElement = document.querySelector('#board');
        const board = new NeoChessBoard(boardElement, {
          position: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
          rulesAdapter: new ChessJsRules(),
          showArrows: true,
          showHighlights: true,
          rightClickHighlights: true,
          interactive: true,
          showCoordinates: true,
        });

        let chessRules = new ChessJsRules();
        chessRules.setFEN('rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1');

        chessRules.setPgnMetadata({
          Event: 'Neo Chess Board Demo',
          Site: 'Local Demo',
          White: 'Player White',
          Black: 'Player Black',
          Date: new Date().toISOString().split('T')[0].replace(/-/g, '.'),
          WhiteElo: '1500',
          BlackElo: '1500',
          TimeControl: '300+3',
          ECO: '?',
          Opening: '?',
        });

        const updateStatus = () => {
          const moveNumber = chessRules.moveNumber();
          const turn = chessRules.turn();
          const inCheck = chessRules.inCheck();
          const isCheckmate = chessRules.isCheckmate();
          const isStalemate = chessRules.isStalemate();
          const isGameOver = chessRules.isGameOver();
          const moves = chessRules.getAllMoves();
          const halfMoves = chessRules.halfMoves();
          const halfMovesRemaining = Math.max(0, 100 - halfMoves);
          const history = chessRules.history();

          document.getElementById('move-number').textContent = String(moveNumber);
          document.getElementById('current-turn').textContent = translate(
            turn === 'w' ? 'status.turn.white' : 'status.turn.black',
          );
          document.getElementById('moves-count').textContent = String(moves.length);
          document.getElementById('half-moves').textContent = String(halfMoves);

          const fiftyMoveEl = document.getElementById('fifty-move-status');
          if (halfMoves >= 100) {
            fiftyMoveEl.textContent = translate('status.fifty.limitReached');
            fiftyMoveEl.className = 'status-value fifty-limit';
          } else {
            fiftyMoveEl.textContent = translate('status.fifty.remaining', {
              count: halfMovesRemaining,
            });
            fiftyMoveEl.className = halfMoves >= 80 ? 'status-value fifty-warning' : 'status-value';
          }

          const checkEl = document.getElementById('check-status');
          if (inCheck) {
            checkEl.textContent = translate('status.check.yes');
            checkEl.className = 'status-value check';
          } else {
            checkEl.textContent = translate('status.check.no');
            checkEl.className = 'status-value';
          }

          const statusEl = document.getElementById('game-status');
          if (isCheckmate) {
            statusEl.textContent = translate('status.state.checkmate');
            statusEl.className = 'status-value checkmate';
          } else if (isStalemate) {
            statusEl.textContent = translate('status.state.stalemate');
            statusEl.className = 'status-value stalemate';
          } else if (isGameOver) {
            statusEl.textContent = translate('status.state.gameOver');
            statusEl.className = 'status-value';
          } else {
            statusEl.textContent = translate('status.state.inProgress');
            statusEl.className = 'status-value normal';
          }

          const historyEl = document.getElementById('moves-history');
          if (history.length === 0) {
            historyEl.textContent = translate('history.initial');
          } else {
            historyEl.innerHTML = history
              .map((move, index) => {
                const moveNum = Math.floor(index / 2) + 1;
                const isWhite = index % 2 === 0;
                const prefix = translate(
                  isWhite ? 'history.movePrefix.white' : 'history.movePrefix.black',
                  { moveNumber: moveNum },
                );
                return isWhite ? `${prefix} ${move}` : `${prefix} ${move}`;
              })
              .join(' ');
          }

          const undoBtn = document.getElementById('undo-btn');
          undoBtn.disabled = history.length === 0;
        };

        const resetGame = () => {
          chessRules.reset();
          board.setPosition(chessRules.getFEN(), true);
          updateStatus();
        };

        const undoMove = () => {
          if (chessRules.undo()) {
            board.setPosition(chessRules.getFEN(), true);
            updateStatus();
          }
        };

        const loadPosition = (positionType) => {
          let fen;
          switch (positionType) {
            case 'scholar':
              fen = 'rnbqkb1r/pppp1ppp/5n2/4p3/2B1P3/3P1Q2/PPP2PPP/RNB1K1NR b KQkq - 0 4';
              break;
            case 'stalemate':
              fen = 'k7/8/1K6/8/8/8/8/1Q6 b - - 0 1';
              break;
            case 'endgame':
              fen = '8/8/8/8/8/3k4/8/K2Q4 w - - 0 1';
              break;
            case 'castling':
              fen = 'r3k2r/pppppppp/8/8/8/8/PPPPPPPP/R3K2R w KQkq - 0 1';
              break;
            default:
              fen = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
          }

          chessRules.setFEN(fen);
          board.setPosition(fen, true);
          updateStatus();
        };

        window.resetGame = resetGame;
        window.undoMove = undoMove;
        window.loadPosition = loadPosition;

        board.on('move', (data) => {
          chessRules.setFEN(data.fen);
          updateStatus();

          if (chessRules.isGameOver()) {
            setTimeout(() => {
              let message;
              if (chessRules.isCheckmate()) {
                const winner = chessRules.turn() === 'w' ? 'status.turn.black' : 'status.turn.white';
                message = translate('alerts.checkmate', { winner: translate(winner) });
              } else if (chessRules.isStalemate()) {
                message = translate('alerts.stalemate');
              } else {
                message = translate('alerts.gameOver');
              }
              alert(message);
            }, 100);
          }
        });

        board.on('illegal', (data) => {
          alert(
            translate('alerts.illegalMove', {
              from: data.from,
              to: data.to,
              reason: data.reason,
            }),
          );
        });

        updateStatus();

        let demoMoves = ['e2', 'e4', 'e7', 'e5', 'f1', 'c4', 'b8', 'c6', 'd1', 'h5'];
        let demoIndex = 0;
        let demoMode = false;

        window.startDemo = function () {
          if (demoMode) return;
          demoMode = true;

          const playNextMove = () => {
            if (demoIndex >= demoMoves.length - 1 || chessRules.isGameOver()) {
              demoMode = false;
              return;
            }

            const from = demoMoves[demoIndex];
            const to = demoMoves[demoIndex + 1];
            const moveResult = chessRules.move({ from, to });
            if (moveResult.ok) {
              board.setPosition(chessRules.getFEN());
              updateStatus();
            }

            demoIndex += 2;
            setTimeout(playNextMove, 1500);
          };

          resetGame();
          setTimeout(playNextMove, 1000);
        };

        window.exportPgn = function () {
          const pgn = chessRules.toPgn();
          const modalTitle = document.getElementById('modal-title');
          modalTitle.dataset.i18n = 'modal.title.exportCurrent';
          modalTitle.textContent = translate('modal.title.exportCurrent');
          document.getElementById('pgn-content').value = pgn;
          const loadButton = document.getElementById('load-pgn-btn');
          loadButton.hidden = true;
          document.getElementById('pgn-modal').style.display = 'block';
        };

        window.downloadPgn = function () {
          const filename = `chess-game-${new Date().toISOString().split('T')[0]}.pgn`;
          chessRules.downloadPgn(filename);
        };

        window.showLoadPgnDialog = function () {
          const modalTitle = document.getElementById('modal-title');
          modalTitle.dataset.i18n = 'modal.title.loadPrompt';
          modalTitle.textContent = translate('modal.title.loadPrompt');
          document.getElementById('pgn-content').value = '';
          const loadButton = document.getElementById('load-pgn-btn');
          loadButton.hidden = false;
          document.getElementById('pgn-modal').style.display = 'block';
        };

        window.loadFromPgn = function () {
          const content = document.getElementById('pgn-content').value.trim();
          if (!content) {
            alert(translate('alerts.emptyPgn'));
            return;
          }

          const success = chessRules.loadPgn(content);
          if (success) {
            board.setPosition(chessRules.getFEN(), true);
            updateStatus();
            closePgnModal();
            alert(translate('alerts.loadSuccess'));
          } else {
            alert(translate('alerts.loadError'));
          }
        };

        window.closePgnModal = function () {
          document.getElementById('pgn-modal').style.display = 'none';
        };

        window.copyPgnToClipboard = function () {
          const pgnContent = document.getElementById('pgn-content');
          pgnContent.select();
          pgnContent.setSelectionRange(0, 99999);

          try {
            document.execCommand('copy');
            alert(translate('alerts.copySuccess'));
          } catch (err) {
            console.error('Failed to copy PGN', err);
            alert(translate('alerts.copyError'));
          }
        };

        window.loadFamousGame = function () {
          const immortalGame = `[Event "Immortal Game"]
[Site "London"]
[Date "1851.06.21"]
[Round "?"]
[White "Anderssen, Adolf"]
[Black "Kieseritzky, Lionel"]
[Result "1-0"]

1. e4 e5 2. f4 exf4 3. Bc4 Qh4+ 4. Kf1 b5 5. Bxb5 Nf6 6. Nf3 Qh6 7. d3 Nh5 8. Nh4 Qg5 9. Nf5 c6 10. g4 Nf6 11. Rg1 cxb5 12. h4 Qg6 13. h5 Qg5 14. Qf3 Ng8 15. Bxf4 Qf6 16. Nc3 Bc5 17. Nd5 Qxb2 18. Bd6 Bxg1 19. e5 Qxa1+ 20. Ke2 Na6 21. Nxg7+ Kd8 22. Qf6+ Nxf6 23. Be7# 1-0`;

          document.getElementById('pgn-content').value = immortalGame;
          const modalTitle = document.getElementById('modal-title');
          modalTitle.dataset.i18n = 'modal.title.famous';
          modalTitle.textContent = translate('modal.title.famous');
          const loadButton = document.getElementById('load-pgn-btn');
          loadButton.hidden = false;
          document.getElementById('pgn-modal').style.display = 'block';
        };

        document.getElementById('pgn-modal').addEventListener('click', function (event) {
          if (event.target === this) {
            window.closePgnModal();
          }
        });
      });
    </script>
  </body>
</html>
